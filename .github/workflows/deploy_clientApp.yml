name: Deploy Client Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - stage
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: windows-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_TERRAFORM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Key Vault URL
        id: get-keyvault
        run: |
          $kvUrl = az keyvault show `
            --name "kv-megabks-trn-mgr-${{ github.event.inputs.environment }}" `
            --resource-group "rg-trn-mgr-${{ github.event.inputs.environment }}" `
            --query "properties.vaultUri" `
            --output tsv
          
          echo "KEYVAULT_URL=$kvUrl" >> $env:GITHUB_ENV
          Write-Host "Key Vault URL: $kvUrl"

      - name: Update appsettings.json
        working-directory: source/main
        run: |
          Write-Host "Updating appsettings.json with Key Vault URL: $env:KEYVAULT_URL"
          
          $appSettings = Get-Content appsettings.json | ConvertFrom-Json
          $appSettings.KeyVaultConfig.VaultUrl = $env:KEYVAULT_URL
          
          $appSettings | ConvertTo-Json -Depth 10 | Set-Content appsettings.json
          
          Write-Host "Updated appsettings.json:"
          Get-Content appsettings.json

      - name: Build application
        working-directory: source/main
        run: |
          dotnet build BowlingMegabucks.TournamentManager.csproj -c Release 

      - name: Get application version
        id: get-version
        working-directory: source/main
        run: |
          [xml]$csproj = Get-Content BowlingMegabucks.TournamentManager.csproj
          $version = $csproj.Project.PropertyGroup.VersionPrefix | Where-Object { $_ -ne $null } | Select-Object -First 1
          echo "VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "Application version: $version"

      - name: Publish ClickOnce
        working-directory: source/main
        env:
          INSTALL_URL: ${{ vars.CLICKONCE_INSTALL_URL }}
        run: |
          dotnet publish BowlingMegabucks.TournamentManager.csproj `
            -c Release `
            -o publish `
            /p:PublishUrl="${env:INSTALL_URL}" `
            /p:InstallUrl="${env:INSTALL_URL}" `
            /p:ApplicationVersion="${env:VERSION}.0"

      - name: Deploy to FTP Server
        working-directory: source/main/publish
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_FOLDER: ${{ vars.FTP_FOLDER }}
        run: |
          Write-Host "Deploying to FTP Server: $env:FTP_SERVER"
          Write-Host "Target folder: $env:FTP_FOLDER"
          
          # Function to upload file via FTP
          function Upload-FileToFtp {
              param(
                  [string]$LocalPath,
                  [string]$RemotePath,
                  [string]$FtpServer,
                  [string]$Username,
                  [string]$Password
              )
              
              $ftpUri = "ftp://$FtpServer/$RemotePath"
              Write-Host "Uploading: $LocalPath -> $ftpUri"
              
              $ftpRequest = [System.Net.FtpWebRequest]::Create($ftpUri)
              $ftpRequest.Method = [System.Net.WebRequestMethods+Ftp]::UploadFile
              $ftpRequest.Credentials = New-Object System.Net.NetworkCredential($Username, $Password)
              $ftpRequest.UseBinary = $true
              $ftpRequest.UsePassive = $true
              
              $fileContent = [System.IO.File]::ReadAllBytes($LocalPath)
              $ftpRequest.ContentLength = $fileContent.Length
              
              $requestStream = $ftpRequest.GetRequestStream()
              $requestStream.Write($fileContent, 0, $fileContent.Length)
              $requestStream.Close()
              
              $response = $ftpRequest.GetResponse()
              Write-Host "Upload completed: $($response.StatusDescription)"
              $response.Close()
          }
          
          # Function to create directory via FTP
          function Create-FtpDirectory {
              param(
                  [string]$RemotePath,
                  [string]$FtpServer,
                  [string]$Username,
                  [string]$Password
              )
              
              try {
                  $ftpUri = "ftp://$FtpServer/$RemotePath"
                  $ftpRequest = [System.Net.FtpWebRequest]::Create($ftpUri)
                  $ftpRequest.Method = [System.Net.WebRequestMethods+Ftp]::MakeDirectory
                  $ftpRequest.Credentials = New-Object System.Net.NetworkCredential($Username, $Password)
                  $ftpRequest.UsePassive = $true
                  
                  $response = $ftpRequest.GetResponse()
                  Write-Host "Directory created: $RemotePath"
                  $response.Close()
              }
              catch {
                  Write-Host "Directory may already exist or creation skipped: $RemotePath"
              }
          }
          
          # Create target directory
          Create-FtpDirectory -RemotePath $env:FTP_FOLDER -FtpServer $env:FTP_SERVER -Username $env:FTP_USERNAME -Password $env:FTP_PASSWORD
          
          # Upload all files
          $files = Get-ChildItem -Recurse -File
          $totalFiles = $files.Count
          $currentFile = 0
          
          foreach ($file in $files) {
              $currentFile++
              $relativePath = $file.FullName.Substring((Get-Location).Path.Length + 1).Replace('\', '/')
              $remotePath = "$env:FTP_FOLDER/$relativePath"
              
              # Create subdirectories if needed
              $remoteDir = Split-Path $remotePath -Parent
              if ($remoteDir -and $remoteDir -ne $env:FTP_FOLDER) {
                  Create-FtpDirectory -RemotePath $remoteDir -FtpServer $env:FTP_SERVER -Username $env:FTP_USERNAME -Password $env:FTP_PASSWORD
              }
              
              Write-Host "[$currentFile/$totalFiles] Uploading $relativePath"
              Upload-FileToFtp -LocalPath $file.FullName -RemotePath $remotePath -FtpServer $env:FTP_SERVER -Username $env:FTP_USERNAME -Password $env:FTP_PASSWORD
          }
          
          Write-Host "Upload successful! Deployed $totalFiles files."
